name: Trigger CodeRabbit Review

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  issues: write
  pull-requests: write

jobs:
  trigger-coderabbit-review:
    # Avoid write-attempt failures on fork PRs where token permissions are reduced.
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Request CodeRabbit review for latest head SHA
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const marker = `<!-- coderabbit-trigger:${pr.head.sha} -->`;
            const body = `${marker}\n@coderabbitai review`;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                per_page: 100,
              },
            );

            const alreadyTriggered = comments.some((comment) => {
              return (
                comment.user?.login === 'github-actions[bot]' &&
                typeof comment.body === 'string' &&
                comment.body.includes(marker)
              );
            });

            if (alreadyTriggered) {
              core.info(`CodeRabbit already triggered for ${pr.head.sha}`);
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body,
            });

            core.info(`Triggered CodeRabbit review for PR #${pr.number} (${pr.head.sha})`);
